<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Appel Vid√©o Simplifi√©</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        video {
            border: 2px solid #333;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #controls button {
            margin-right: 10px;
        }
    </style>
</head>
<body class="container mt-4">

    <h3>Appel Vid√©o Simplifi√©</h3>

    <div class="row">
        <div class="col-md-6">
            <h5>Ma vid√©o (local)</h5>
            <video id="localVideo" autoplay muted playsinline style="width:100%; height:auto;"></video>
        </div>
        <div class="col-md-6">
            <h5>Vid√©o distante</h5>
            <video id="remoteVideo" autoplay playsinline style="width:100%; height:auto;"></video>
        </div>
    </div>

    <div id="controls" class="mt-3">
        <div id="initial-options">
            <button id="createCallBtn" class="btn btn-primary mb-2">Cr√©er un appel</button>
            <button id="joinCallBtn" class="btn btn-secondary mb-2">Rejoindre un appel</button>
        </div>

        <div id="create-call-section" style="display:none;">
            <p>Votre ID d'appel: <strong id="callIdDisplay"></strong>
                <button id="copyIdBtn" class="btn btn-sm btn-outline-secondary">Copier ID</button>
            </p>
            <p>Lien d'invitation: <a href="#" id="inviteLink" target="_blank"></a>
                <button id="copyLinkBtn" class="btn btn-sm btn-outline-secondary">Copier Lien</button>
            </p>
            <button id="startCallCreatorBtn" class="btn btn-success">D√©marrer l'appel</button>
        </div>

        <div id="join-call-section" style="display:none;">
            <input type="text" id="joinCallId" placeholder="Entrez l'ID de l'appel" class="form-control mb-2">
            <button id="joinCallSubmitBtn" class="btn btn-success">Rejoindre</button>
        </div>

        <div id="in-call-controls" style="display:none;">
            <input type="text" id="myUsername" placeholder="Mon nom d'utilisateur" class="form-control mb-2" disabled>
            <button id="muteBtn" class="btn btn-warning">üîá Mute</button>
            <button id="hangupBtn" class="btn btn-danger">‚ùå Raccrocher</button>
        </div>
    </div>

    <script>
        let myUsername = '';
        let currentCallId = '';
        let connection;
        let localStream;
        let peerConnection;
        let isCallCreator = false; // Pour savoir si cet utilisateur est le cr√©ateur de l'appel
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                // Serveurs TURN publics (pour les tests, pas pour la production)
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ]
        };

        // G√©n√©rer un ID unique pour l'appel
        function generateCallId() {
            return Math.random().toString(36).substring(2, 9); // ID alphanum√©rique court
        }

        // Afficher les sections
        function showSection(sectionId) {
            document.getElementById('initial-options').style.display = 'none';
            document.getElementById('create-call-section').style.display = 'none';
            document.getElementById('join-call-section').style.display = 'none';
            document.getElementById('in-call-controls').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }

        // Initialisation du flux local
        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (err) {
                console.error("Erreur d'acc√®s √† la cam√©ra/micro:", err);
                alert("Impossible d'acc√©der √† la cam√©ra/micro. Veuillez v√©rifier les permissions.");
            }
        }

        // Connexion au serveur WebSocket
        function connectWebSocket(username, creatorStatus) {
            myUsername = username;
            isCallCreator = creatorStatus;
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            connection = new WebSocket(`${wsProtocol}//${window.location.host}`);

            connection.onopen = () => {
                console.log("‚úÖ Connect√© au serveur WebSocket !");
                connection.send(JSON.stringify({ type: 'login', name: myUsername }));

                if (isCallCreator) {
                    connection.send(JSON.stringify({ type: 'create_call', callId: currentCallId, name: myUsername }));
                } else {
                    connection.send(JSON.stringify({ type: 'join_call', callId: currentCallId, name: myUsername }));
                }

                document.getElementById('myUsername').value = myUsername; // Afficher le nom d'utilisateur
                document.getElementById('myUsername').disabled = true;
                showSection('in-call-controls'); // Afficher les contr√¥les d'appel
            };

            connection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Message re√ßu :', data);

                switch (data.type) {
                    case 'new_participant': // Un nouveau participant a rejoint la salle
                        alert(`Un nouveau participant a rejoint l'appel : ${data.from}`);
                        // Si je suis le cr√©ateur, je dois initier l'offre avec ce nouveau participant
                        if (isCallCreator) {
                            startPeerConnection(data.from); // La cible est le nouveau participant
                            createAndSendOffer();
                        }
                        break;
                    case 'signal':
                        handleSignal(data.from, data.signalData);
                        break;
                    case 'hangup':
                        handleRemoteHangUp();
                        break;
                    case 'user_disconnected':
                        alert(`${data.from} a quitt√© l'appel.`);
                        // G√©rer la d√©connexion d'un utilisateur sp√©cifique si n√©cessaire
                        break;
                    case 'error':
                        alert('Erreur du serveur: ' + data.message);
                        resetCallState();
                        showSection('initial-options');
                        break;
                }
            };

            connection.onerror = (error) => {
                console.error("‚ùå Erreur WebSocket :", error);
                alert("Erreur de connexion WebSocket. Veuillez v√©rifier le serveur.");
            };

            connection.onclose = () => {
                console.log("‚ùå D√©connect√© du serveur WebSocket");
                resetCallState();
                alert('D√©connect√© du serveur ou l\'appel a √©t√© raccroch√©.');
                showSection('initial-options'); // Revenir aux options initiales
            };
        }

        // R√©initialiser l'√©tat de l'appel
        function resetCallState() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('localVideo').srcObject = null;
            myUsername = '';
            currentCallId = '';
            isCallCreator = false;
            document.getElementById('myUsername').disabled = false;
            document.getElementById('myUsername').value = '';
            document.getElementById('joinCallId').value = '';
            document.getElementById('callIdDisplay').innerText = '';
            document.getElementById('inviteLink').href = '#';
            document.getElementById('inviteLink').innerText = '';
        }

        // Logique WebRTC
        function startPeerConnection(targetUserForSignal) {
            console.log('D√©marrage de PeerConnection avec cible:', targetUserForSignal);
            peerConnection = new RTCPeerConnection(config);

            peerConnection.onicecandidate = (event) => {
                console.log('ICE Candidate:', event.candidate);
                if (event.candidate) {
                    connection.send(JSON.stringify({
                        type: 'signal',
                        name: myUsername,
                        target: targetUserForSignal, // La cible est l'autre utilisateur sp√©cifique
                        callId: currentCallId, // Inclure l'ID d'appel
                        signalData: { type: 'ice', candidate: event.candidate }
                    }));
                }
            };

            peerConnection.ontrack = (event) => {
                console.log('Flux distant re√ßu (ontrack) :', event.streams[0]);
                if (event.streams && event.streams[0]) {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    console.log('Flux distant assign√© √† remoteVideo.');
                } else {
                    console.warn('Aucun flux valide dans event.streams[0] pour ontrack.');
                }
            };

            peerConnection.onconnectionstatechange = (event) => {
                console.log('Connection State Change:', peerConnection.connectionState);
            };

            peerConnection.oniceconnectionstatechange = (event) => {
                console.log('ICE Connection State Change:', peerConnection.iceConnectionState);
            };

            if (localStream) {
                console.log('Ajout des pistes locales √† PeerConnection.');
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            } else {
                console.log('D√©marrage du flux local avant d\'ajouter les pistes.');
                startLocalStream().then(() => {
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                });
            }
        }

        async function createAndSendOffer() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            connection.send(JSON.stringify({
                type: 'signal',
                name: myUsername,
                target: currentCallId, // La cible est l'ID de l'appel pour le routage serveur
                callId: currentCallId,
                signalData: { type: 'offer', offer: offer }
            }));
        }

        async function createAndSendAnswer() {
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            connection.send(JSON.stringify({
                type: 'signal',
                name: myUsername,
                target: currentCallId, // La cible est l'ID de l'appel pour le routage serveur
                callId: currentCallId,
                signalData: { type: 'answer', answer: answer }
            }));
        }

        async function handleSignal(from, signal) {
            console.log(`Gestion du signal de ${from}:`, signal.type);
            if (signal.type === 'offer') {
                if (!peerConnection) {
                    console.log('PeerConnection non existante, cr√©ation pour l\'offre entrante.');
                    startPeerConnection(from); // La cible pour la r√©ponse est l'exp√©diteur de l'offre
                }
                await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.offer));
                console.log('Offre distante d√©finie. Cr√©ation et envoi de la r√©ponse.');
                createAndSendAnswer(); // R√©pondre √† l'offre
            } else if (signal.type === 'answer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.answer));
                console.log('R√©ponse distante d√©finie.');
            } else if (signal.type === 'ice') {
                if (peerConnection && signal.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
                    console.log('ICE Candidate ajout√©.');
                } else {
                    console.warn('Impossible d\'ajouter ICE Candidate: peerConnection non d√©fini ou candidate manquant.');
                }
            }
        }

        function handleRemoteHangUp() {
            alert('L\'autre partie a raccroch√©.');
            resetCallState();
            showSection('initial-options');
        }

        // Gestionnaires d'√©v√©nements pour les boutons
        document.getElementById('createCallBtn').onclick = () => {
            currentCallId = generateCallId();
            document.getElementById('callIdDisplay').innerText = currentCallId;
            const inviteLink = `${window.location.origin}?callId=${currentCallId}`;
            document.getElementById('inviteLink').href = inviteLink;
            document.getElementById('inviteLink').innerText = inviteLink;
            showSection('create-call-section');
            startLocalStream(); // D√©marrer le flux local d√®s la cr√©ation de l'appel
        };

        document.getElementById('joinCallBtn').onclick = () => {
            showSection('join-call-section');
            startLocalStream(); // D√©marrer le flux local d√®s la tentative de rejoindre
        };

        document.getElementById('copyIdBtn').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('callIdDisplay').innerText)
                .then(() => alert('ID copi√© !'))
                .catch(err => console.error('Erreur de copie:', err));
        };

        document.getElementById('copyLinkBtn').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('inviteLink').href)
                .then(() => alert('Lien copi√© !'))
                .catch(err => console.error('Erreur de copie:', err));
        };

        document.getElementById('startCallCreatorBtn').onclick = () => {
            const creatorUsername = `creator-${currentCallId}`; // Nom d'utilisateur unique pour le cr√©ateur
            connectWebSocket(creatorUsername, true); // true pour indiquer que c'est le cr√©ateur
        };

        document.getElementById('joinCallSubmitBtn').onclick = () => {
            const joinId = document.getElementById('joinCallId').value;
            if (joinId) {
                currentCallId = joinId;
                const joinerUsername = `joiner-${currentCallId}-${generateCallId()}`; // Nom d'utilisateur unique pour celui qui rejoint
                connectWebSocket(joinerUsername, false); // false pour indiquer que c'est celui qui rejoint
            } else {
                alert("Veuillez entrer l'ID de l'appel √† rejoindre.");
            }
        };

        document.getElementById('muteBtn').onclick = () => {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
                document.getElementById('muteBtn').innerText = localStream.getAudioTracks()[0].enabled ? "üîá Mute" : "üîä Unmute";
            }
        };

        document.getElementById('hangupBtn').onclick = () => {
            if (connection && connection.readyState === WebSocket.OPEN) {
                connection.send(JSON.stringify({ type: 'hangup', from: myUsername, callId: currentCallId }));
            }
            alert('Appel termin√©.');
            resetCallState();
            showSection('initial-options');
        };

        // V√©rifier l'URL pour un ID d'appel (pour les liens d'invitation)
        const urlParams = new URLSearchParams(window.location.search);
        const initialCallId = urlParams.get('callId');
        if (initialCallId) {
            document.getElementById('joinCallId').value = initialCallId;
            showSection('join-call-section');
            startLocalStream();
        } else {
            showSection('initial-options');
        }
    </script>

</body>
</html>