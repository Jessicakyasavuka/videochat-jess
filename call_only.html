<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Appel Vid√©o Simplifi√©</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        video {
            border: 2px solid #333;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #controls button {
            margin-right: 10px;
        }
    </style>
</head>
<body class="container mt-4">

    <h3>Appel Vid√©o Simplifi√©</h3>

    <div class="row">
        <div class="col-md-6">
            <h5>Ma vid√©o (local)</h5>
            <video id="localVideo" autoplay muted playsinline style="width:100%; height:auto;"></video>
        </div>
        <div class="col-md-6">
            <h5>Vid√©o distante</h5>
            <video id="remoteVideo" autoplay playsinline style="width:100%; height:auto;"></video>
        </div>
    </div>

    <div id="controls" class="mt-3">
        <div id="initial-options">
            <button id="createCallBtn" class="btn btn-primary mb-2">Cr√©er un appel</button>
            <button id="joinCallBtn" class="btn btn-secondary mb-2">Rejoindre un appel</button>
        </div>

        <div id="create-call-section" style="display:none;">
            <p>Votre ID d'appel: <strong id="callIdDisplay"></strong>
                <button id="copyIdBtn" class="btn btn-sm btn-outline-secondary">Copier ID</button>
            </p>
            <p>Lien d'invitation: <a href="#" id="inviteLink" target="_blank"></a>
                <button id="copyLinkBtn" class="btn btn-sm btn-outline-secondary">Copier Lien</button>
            </p>
            <button id="startCallCreatorBtn" class="btn btn-success">D√©marrer l'appel</button>
        </div>

        <div id="join-call-section" style="display:none;">
            <input type="text" id="joinCallId" placeholder="Entrez l'ID de l'appel" class="form-control mb-2">
            <button id="joinCallSubmitBtn" class="btn btn-success">Rejoindre</button>
        </div>

        <div id="in-call-controls" style="display:none;">
            <input type="text" id="myUsername" placeholder="Mon nom d'utilisateur" class="form-control mb-2" disabled>
            <button id="muteBtn" class="btn btn-warning">üîá Mute</button>
            <button id="hangupBtn" class="btn btn-danger">‚ùå Raccrocher</button>
        </div>
    </div>

    <script src="webrtc.js"></script>
    <script>
        let myUsername = '';
        let currentCallId = '';
        let connection; // La connexion WebSocket
        let isCallCreator = false; // Pour savoir si cet utilisateur est le cr√©ateur de l'appel

        // G√©n√©rer un ID unique pour l'appel
        function generateCallId() {
            return Math.random().toString(36).substring(2, 9); // ID alphanum√©rique court
        }

        // Afficher les sections
        function showSection(sectionId) {
            document.getElementById('initial-options').style.display = 'none';
            document.getElementById('create-call-section').style.display = 'none';
            document.getElementById('join-call-section').style.display = 'none';
            document.getElementById('in-call-controls').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';
        }

        // R√©initialiser l'√©tat de l'appel
        function resetCallState() {
            // Appeler la fonction de r√©initialisation de webrtc.js
            resetWebRTCState();
            myUsername = '';
            currentCallId = '';
            isCallCreator = false;
            document.getElementById('myUsername').disabled = false;
            document.getElementById('myUsername').value = '';
            document.getElementById('joinCallId').value = '';
            document.getElementById('callIdDisplay').innerText = '';
            document.getElementById('inviteLink').href = '#';
            document.getElementById('inviteLink').innerText = '';
        }

        // Connexion au serveur WebSocket
        function connectWebSocket(username, creatorStatus) {
            myUsername = username;
            isCallCreator = creatorStatus;
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            connection = new WebSocket(`${wsProtocol}//${window.location.host}`);

            connection.onopen = () => {
                console.log("‚úÖ Connect√© au serveur WebSocket !");
                connection.send(JSON.stringify({ type: 'login', name: myUsername }));

                if (isCallCreator) {
                    connection.send(JSON.stringify({ type: 'create_call', callId: currentCallId, name: myUsername }));
                } else {
                    connection.send(JSON.stringify({ type: 'join_call', callId: currentCallId, name: myUsername }));
                }

                document.getElementById('myUsername').value = myUsername; // Afficher le nom d'utilisateur
                document.getElementById('myUsername').disabled = true;
                showSection('in-call-controls'); // Afficher les contr√¥les d'appel

                // Initialiser WebRTC avec la connexion WebSocket
                initWebRTC(connection, myUsername, currentCallId, isCallCreator);
            };

            connection.onclose = () => {
                console.log("‚ùå D√©connect√© du serveur WebSocket");
                resetCallState(); // R√©initialiser l'√©tat de l'UI
                alert('D√©connect√© du serveur ou l\'appel a √©t√© raccroch√©.');
                showSection('initial-options'); // Revenir aux options initiales
            };

            connection.onerror = (error) => {
                console.error("‚ùå Erreur WebSocket :", error);
                alert("Erreur de connexion WebSocket. Veuillez v√©rifier le serveur.");
                resetCallState();
                showSection('initial-options');
            };
        }

        // Gestionnaires d'√©v√©nements pour les boutons
        document.getElementById('createCallBtn').onclick = () => {
            currentCallId = generateCallId();
            document.getElementById('callIdDisplay').innerText = currentCallId;
            const inviteLink = `${window.location.origin}?callId=${currentCallId}`;
            document.getElementById('inviteLink').href = inviteLink;
            document.getElementById('inviteLink').innerText = inviteLink;
            showSection('create-call-section');
            startLocalStream(); // D√©marrer le flux local d√®s la cr√©ation de l'appel
        };

        document.getElementById('joinCallBtn').onclick = () => {
            showSection('join-call-section');
            startLocalStream(); // D√©marrer le flux local d√®s la tentative de rejoindre
        };

        document.getElementById('copyIdBtn').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('callIdDisplay').innerText)
                .then(() => alert('ID copi√© !'))
                .catch(err => console.error('Erreur de copie:', err));
        };

        document.getElementById('copyLinkBtn').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('inviteLink').href)
                .then(() => alert('Lien copi√© !'))
                .catch(err => console.error('Erreur de copie:', err));
        };

        document.getElementById('startCallCreatorBtn').onclick = () => {
            const creatorUsername = `creator-${currentCallId}`; // Nom d'utilisateur unique pour le cr√©ateur
            connectWebSocket(creatorUsername, true); // true pour indiquer que c'est le cr√©ateur
            // La PeerConnection et l'offre seront initi√©es par initWebRTC et new_participant dans webrtc.js
        };

        document.getElementById('joinCallSubmitBtn').onclick = () => {
            const joinId = document.getElementById('joinCallId').value;
            if (joinId) {
                currentCallId = joinId;
                const joinerUsername = `joiner-${currentCallId}-${generateCallId()}`; // Nom d'utilisateur unique pour celui qui rejoint
                connectWebSocket(joinerUsername, false); // false pour indiquer que c'est celui qui rejoint
            } else {
                alert("Veuillez entrer l'ID de l'appel √† rejoindre.");
            }
        };

        document.getElementById('muteBtn').onclick = () => {
            toggleMute(); // Appelle la fonction de webrtc.js
            document.getElementById('muteBtn').innerText = localStream.getAudioTracks()[0].enabled ? "üîá Mute" : "üîä Unmute";
        };

        document.getElementById('hangupBtn').onclick = () => {
            if (connection && connection.readyState === WebSocket.OPEN) {
                connection.send(JSON.stringify({ type: 'hangup', from: myUsername, callId: currentCallId }));
            }
            hangUpCall(); // Appelle la fonction de webrtc.js pour fermer la PeerConnection
            alert('Appel termin√©.');
            resetCallState();
            showSection('initial-options');
        };

        // V√©rifier l'URL pour un ID d'appel (pour les liens d'invitation)
        const urlParams = new URLSearchParams(window.location.search);
        const initialCallId = urlParams.get('callId');
        if (initialCallId) {
            document.getElementById('joinCallId').value = initialCallId;
            showSection('join-call-section');
            startLocalStream();
        } else {
            showSection('initial-options');
        }
    </script>

</body>
</html>